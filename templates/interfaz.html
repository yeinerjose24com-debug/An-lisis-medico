<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Interfaz An√°lisis de Enfermedades ‚Äî Modern</title>

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f6f9fc;
      --card:#ffffffcc;
      --glass: rgba(255,255,255,0.7);
      --accent:#2563eb; /* azul cl√≠nico */
      --accent-2:#6b8cff;
      --muted:#6b7280;
      --success:#10b981;
      --danger:#ef4444;
      --radius:14px;
      --shadow: 0 8px 24px rgba(16,24,40,0.06);
      --glass-shadow: 0 6px 18px rgba(37,99,235,0.06);
    }

    *{ box-sizing: border-box; margin:0; padding:0; font-family: 'Poppins', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }

    body{
      background: linear-gradient(180deg, #f7fbff 0%, var(--bg) 100%);
      color:#0f172a;
      padding:28px;
      display:flex;
      justify-content:center;
      min-height:100vh;
    }

    .contenedor{
      width: 1200px;
      display:grid;
      grid-template-columns: 340px 1fr 360px;
      gap:20px;
      align-items:start;
      background: transparent;
    }

    /* Header card (full width above grid) */
    .header{
      grid-column: 1 / 4;
      background: linear-gradient(90deg, rgba(37,99,235,0.08), rgba(107,140,255,0.04));
      border-radius: var(--radius);
      padding:20px 26px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      box-shadow: var(--glass-shadow);
      backdrop-filter: blur(6px);
    }

    .brand {
      display:flex;
      gap:16px;
      align-items:center;
    }
    .brand .logo{
      width:58px; height:58px;
      border-radius:12px;
      background:linear-gradient(135deg,var(--accent),var(--accent-2));
      display:flex;
      align-items:center;
      justify-content:center;
      color:white;
      font-weight:700;
      box-shadow: 0 6px 18px rgba(37,99,235,0.16);
    }
    .brand h1{ font-size:20px; letter-spacing: -0.2px; margin-bottom:4px; }
    .brand p{ font-size:13px; color:var(--muted); margin-top:2px; }

    .header-actions{
      display:flex;
      gap:12px;
      align-items:center;
    }
    .header-actions button{
      background: white;
      border:1px solid #e6eefc;
      padding:8px 12px;
      border-radius:10px;
      font-weight:600;
      color:var(--accent);
      cursor:pointer;
      box-shadow: 0 6px 18px rgba(37,99,235,0.03);
    }

    /* LEFT COLUMN: form */
    .panel{
      background: var(--card);
      border-radius: 12px;
      padding:18px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(15,23,42,0.04);
    }

    .panel h3{ font-size:16px; margin-bottom:8px; }
    .panel p.desc{ font-size:13px; color:var(--muted); margin-bottom:12px; }

    .campo {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:12px;
      border-radius:10px;
      border:1px solid rgba(15,23,42,0.04);
      margin-bottom:10px;
      background: linear-gradient(180deg, rgba(255,255,255,0.9), rgba(255,255,255,0.82));
      transition: transform .18s ease, box-shadow .18s ease;
    }
    .campo:hover{ transform: translateY(-4px); box-shadow: 0 10px 30px rgba(16,24,40,0.06); }

    .campo label{ font-weight:600; color:#0f172a; font-size:14px; }
    .campo select{
      padding:8px 10px;
      border-radius:8px;
      border:1px solid #e6eefc;
      background:white;
      font-weight:600;
      color:#0f172a;
      cursor:pointer;
    }
    .campo input[type="number"]{
      width: 120px;
      padding:8px 10px;
      border-radius:8px;
      border:1px solid #e6eefc;
      background:white;
      font-weight:600;
      color:#0f172a;
    }

    .small-note{ font-size:12px; color:var(--muted); margin-top:8px; }

    .panel .actions{
      display:flex; gap:10px; margin-top:12px; justify-content:flex-start;
    }

    .btn{
      padding:10px 14px;
      border-radius:10px;
      border:none;
      cursor:pointer;
      font-weight:700;
      letter-spacing:0.2px;
    }
    .btn-primary{ background:var(--accent); color:white; box-shadow: 0 8px 24px rgba(37,99,235,0.12); }
    .btn-ghost{ background:transparent; border:1px solid rgba(15,23,42,0.06); color:var(--muted); }
    .btn-yellow{ background: #facc15; color:#1f2937; font-weight:800; }

    /* CENTER: hero image + info */
    .hero{
      background: linear-gradient(180deg, rgba(255,255,255,0.6), rgba(255,255,255,0.8));
      border-radius:12px; padding:18px;
      box-shadow: var(--shadow);
      display:flex; flex-direction:column; gap:14px;
      border:1px solid rgba(15,23,42,0.03);
    }

    .hero .cover{
      height:260px; border-radius:12px; overflow:hidden; position:relative;
      border:1px solid rgba(15,23,42,0.03);
      background:linear-gradient(90deg,#eef6ff, #ffffff);
      display:flex; align-items:center; justify-content:center;
    }
    .cover img{
      width:100%; height:100%; object-fit:cover; transition: transform .6s ease;
      display:block; filter: saturate(1.02);
    }
    .cover:hover img{ transform: scale(1.04); }

    .cards{
      display:grid; grid-template-columns: repeat(2,1fr); gap:12px;
    }
    .mini-card{
      background:white; padding:12px; border-radius:10px; display:flex; gap:10px; align-items:center;
      border:1px solid rgba(15,23,42,0.03);
    }
    .mini-card img{ width:112px; height:112px; object-fit:cover; border-radius:8px; box-shadow: 0 8px 24px rgba(16,24,40,0.04); transition: transform .4s ease;}
    .mini-card:hover img{ transform: scale(1.06); }

    .mini-card .meta h4{ font-size:14px; margin-bottom:6px; }
    .mini-card .meta p{ font-size:12px; color:var(--muted); }

    /* RIGHT: results panel */
    .resultados{
      display:flex; flex-direction:column; gap:14px;
      position:relative;
    }
    .resultados .panel{ padding:16px; border-radius:12px; }

    .resultado-box{
      height: 420px; overflow:auto;
      background: linear-gradient(180deg, rgba(255,255,255,0.95), rgba(250,250,255,0.95));
      border-radius:12px; padding:16px; box-shadow: var(--shadow);
      border:1px solid rgba(15,23,42,0.03);
    }

    .enfermedad{
      padding:12px; border-radius:10px; font-weight:800; text-align:center; margin-bottom:12px;
    }
    .dengue{ background: linear-gradient(90deg,#fff7ed,#fde68a); color:#92400e; box-shadow: 0 8px 24px rgba(253,230,138,0.18);}    
    .malaria{ background: linear-gradient(90deg,#f0fdf4,#bbf7d0); color:#065f46; box-shadow: 0 8px 24px rgba(187,247,208,0.16);}    
    .leptospirosis{ background: linear-gradient(90deg,#eef2ff,#c7d2fe); color:#3730a3; box-shadow: 0 8px 24px rgba(199,210,254,0.16);}    

    .result-list{ list-style:none; margin-top:8px; }
    .result-list li{ padding:8px 10px; border-radius:8px; margin-bottom:8px; background: rgba(15,23,42,0.02); display:flex; justify-content:space-between; align-items:center; }

    .badge{ font-weight:700; padding:6px 8px; border-radius:8px; font-size:13px; }

    .progress{
      height:10px; width:100%; background: rgba(15,23,42,0.06); border-radius:999px; overflow:hidden;
    }
    .progress > i{ display:block; height:100%; background: linear-gradient(90deg,var(--accent),var(--accent-2)); width:0%; transition: width .6s ease; }

    /* responsive adjustments */
    @media (max-width:1220px){
      .contenedor{ width:100%; grid-template-columns: 1fr; padding:14px; }
      .header{ grid-column:1/2; flex-direction:column; gap:12px; align-items:flex-start; }
      .resultados{ order:3; }
    }

    /* Optimizaci√≥n para tel√©fonos ~6.7" (aprox. ‚â§ 430px de ancho) */
    @media (max-width: 430px){
      body{ padding:14px; }
      .contenedor{ gap:12px; }

      .header{ padding:14px; }
      .brand .logo{ width:44px; height:44px; border-radius:10px; font-size:16px; }
      .brand h1{ font-size:16px; }
      .brand p{ font-size:12px; }

      .panel{ padding:14px; border-radius:10px; }
      .panel h3{ font-size:15px; }
      .panel p.desc{ font-size:12px; }

      .campo{ padding:10px; gap:8px; }
      .campo label{ font-size:13px; }
      .campo select, .campo input[type="number"]{ width: 100%; max-width: none; font-size:14px; }

      .actions{ flex-wrap: wrap; }
      .btn{ width:100%; padding:12px; font-size:14px; }

      .hero{ padding:12px; }
      .hero .cover{ height: 200px; }
      .mini-card{ padding:10px; }
      .mini-card img{ width:96px; height:96px; }
      .mini-card .meta h4{ font-size:13px; }
      .mini-card .meta p{ font-size:12px; }

      .resultado-box{ height:auto; max-height: 70vh; }

      /* Grillas a una sola columna */
      .cards{ grid-template-columns: 1fr; }

      /* Tipograf√≠as generales un poco m√°s compactas */
      .badge{ font-size:12px; }

      /* Prevenir overflow horizontal */
      img{ max-width:100%; height:auto; }
      .panel, .header, .hero, .resultados{ overflow:hidden; }
    }

    /* Ajustes para 360‚Äì390px */
    @media (max-width: 390px){
      .brand h1{ font-size:15px; }
      .header-actions button{ padding:6px 8px; font-size:12px; }
    }

    /* Ajustes para muy estrechos ‚â§ 360px */
    @media (max-width: 360px){
      .brand h1{ font-size:14px; }
      .brand p{ display:none; }
    }

    /* Modal para ampliar gr√°ficas */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.8);
      animation: fadeIn 0.3s;
    }

    .modal-content {
      position: relative;
      margin: 2% auto;
      width: 90%;
      max-width: 1200px;
      background: white;
      border-radius: 12px;
      padding: 20px;
      animation: slideDown 0.3s;
    }

    .close {
      position: absolute;
      right: 20px;
      top: 15px;
      font-size: 28px;
      font-weight: bold;
      color: #aaa;
      cursor: pointer;
    }

    .close:hover {
      color: #000;
    }

    .modal-img {
      width: 100%;
      height: auto;
      border-radius: 8px;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideDown {
      from { transform: translateY(-50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .grafica-clickable {
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .grafica-clickable:hover {
      transform: scale(1.02);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
    }
  </style>
</head>
<body>

  <div class="contenedor">

    <!-- HEADER -->
    <div class="header">
      <div class="brand">
        <div class="logo">HS</div>
        <div>
          <h1>DEMALE ‚Äî Analizador Cl√≠nico</h1>
          <p>Predicci√≥n r√°pida: Dengue ¬∑ Malaria ¬∑ Leptospirosis</p>
        </div>
      </div>

      <div class="header-actions">
        <button title="Documentaci√≥n">Docs</button>
        <button title="Configuraci√≥n">Config</button>
      </div>
    </div>

    <!-- LEFT: formulario s√≠ntomas -->
    <div class="panel">
      <!-- Imagen de Predicci√≥n Individual arriba -->
      <div class="mini-card" style="margin-bottom:16px; padding:10px;">
        <img src="static/examen predictivo.webp?v=1" alt="Predictivo">
        <div class="meta">
          <h4>Predicci√≥n individual</h4>
          <p>Responde los 5 s√≠ntomas y obt√©n una sugerencia inmediata.</p>
        </div>
      </div>
      
      <h3>Formulario r√°pido ‚Äî 5 s√≠ntomas</h3>
      <p class="desc">Marca si el paciente presenta cada s√≠ntoma. Luego presiona <b>Predecir</b> para obtener una estimaci√≥n local instant√°nea.</p>

      <!-- S√çNTOMAS -->
      <div class="campo">
        <label for="fiebre">¬øTiene fiebre?</label>
        <select id="fiebre">
          <option value="0">No</option>
          <option value="1">S√≠</option>
        </select>
      </div>

      <div class="campo">
        <label for="rash">¬øErupci√≥n cut√°nea (rash)?</label>
        <select id="rash">
          <option value="0">No</option>
          <option value="1">S√≠</option>
        </select>
      </div>

      <div class="campo">
        <label for="abdominal_pain">¬øDolor abdominal?</label>
        <select id="abdominal_pain">
          <option value="0">No</option>
          <option value="1">S√≠</option>
        </select>
      </div>

      <div class="campo">
        <label for="dizziness">¬øMareos?</label>
        <select id="dizziness">
          <option value="0">No</option>
          <option value="1">S√≠</option>
        </select>
      </div>

      <div class="campo">
        <label for="chills">¬øEscalofr√≠os?</label>
        <select id="chills">
          <option value="0">No</option>
          <option value="1">S√≠</option>
        </select>
      </div>

      <!-- OPCIONALES DE LABORATORIO -->
      <div class="campo">
        <label for="hemoglobin">Hemoglobina (opcional)</label>
        <input type="number" id="hemoglobin" step="any" placeholder="ej. 13.5" />
      </div>
      <div class="campo">
        <label for="red_blood_cells">Gl√≥bulos rojos (opcional)</label>
        <input type="number" id="red_blood_cells" step="any" placeholder="ej. 4.6" />
      </div>
      <div class="campo">
        <label for="white_blood_cells">Gl√≥bulos blancos (opcional)</label>
        <input type="number" id="white_blood_cells" step="any" placeholder="ej. 7000" />
      </div>

      <div class="actions">
        <button id="predecir" class="btn btn-primary">Predecir (local)</button>
        <button id="predecirServidor" class="btn btn-ghost" title="Enviar al servidor">Predecir (server)</button>
        <button id="clear" class="btn btn-ghost">Limpiar</button>
      </div>

      <p class="small-note">Sugerencia: Este predictor usa una regla probabil√≠stica simple basada en la combinaci√≥n de los 5 s√≠ntomas. Para mayor precisi√≥n integrar modelo entrenado del dataset.</p>
      
      <hr style="border:none;height:1px;background:rgba(15,23,42,0.1);margin:16px 0;">
      
      <!-- Imagen de An√°lisis por Lotes arriba -->
      <div class="mini-card" style="margin-bottom:16px; padding:10px;">
        <img src="static/examen por lote.webp?v=1" alt="Lotes">
        <div class="meta">
          <h4>An√°lisis por lotes</h4>
          <p>Carga un archivo .xlsx con los casos y procesa m√∫ltiples registros.</p>
        </div>
      </div>
      
      <h3 style="font-size:14px; margin-bottom:8px;">An√°lisis por Lotes</h3>
      <p class="desc" style="font-size:12px; margin-bottom:10px;">Carga un archivo Excel (.xlsx) para procesar m√∫ltiples casos</p>
      
      <div style="margin-bottom:12px;">
        <input type="file" id="fileInput" accept=".xlsx,.xls" style="display:none;">
        <button id="btnCargarArchivo" class="btn btn-primary" style="width:100%;">Seleccionar archivo Excel</button>
      </div>
      
      <div id="fileInfo" style="display:none; padding:10px; background:rgba(37,99,235,0.05); border-radius:8px; margin-bottom:10px;">
        <p style="font-size:12px; margin-bottom:0;"><strong id="fileName"></strong></p>
      </div>
      
      <p class="small-note">El archivo debe tener las columnas: fever, rash, abdominal_pain, dizziness, chills. Opcionales: hemoglobin, red_blood_cells, white_blood_cells.</p>
    </div>

    <!-- CENTER: imagen grande + mini tarjetas -->
    <!-- Imagen principal -->
<!-- CENTER: imagen grande + mini tarjetas -->
<div class="hero">
  <div class="cover">
    <img src="static/bienvenida.webp?v=1" alt="Bienvenida" id="mainImage">
  </div>

  <!-- Informaci√≥n sobre las enfermedades -->
  <div class="panel" style="margin-top:20px;">
    <h3>Informaci√≥n sobre las Enfermedades</h3>
    <p class="desc">El dengue, la malaria y la leptospirosis son enfermedades febriles con s√≠ntomas similares, como fiebre, dolor de cabeza y malestar general, lo que dificulta su diagn√≥stico temprano.</p>
    
    <div style="margin-top:16px;">
      <h4 style="color:var(--accent); margin-bottom:8px; display:flex; align-items:center; gap:8px;">
        <span style="background:#fbbf24; color:#92400e; padding:4px 8px; border-radius:6px; font-size:14px;">1</span>
        Dengue
      </h4>
      <ul style="margin-left:20px; color:var(--muted); font-size:13px; line-height:1.6;">
        <li><strong>Agente causal:</strong> Virus del g√©nero Flavivirus.</li>
        <li><strong>Transmisi√≥n:</strong> Picadura de mosquitos Aedes aegypti.</li>
        <li><strong>S√≠ntomas:</strong> Fiebre alta, dolor de cabeza intenso, dolor detr√°s de los ojos, dolor muscular y articular. Tambi√©n puede presentar signos de alarma como decaimiento severo, dolor abdominal persistente, v√≥mito, sangrado de enc√≠as o moretones.</li>
        <li><strong>Complicaciones:</strong> Puede evolucionar a formas graves con hemorragias y shock.</li>
      </ul>
    </div>

    <div style="margin-top:16px;">
      <h4 style="color:var(--accent); margin-bottom:8px; display:flex; align-items:center; gap:8px;">
        <span style="background:#10b981; color:#065f46; padding:4px 8px; border-radius:6px; font-size:14px;">2</span>
        Malaria (Paludismo)
      </h4>
      <ul style="margin-left:20px; color:var(--muted); font-size:13px; line-height:1.6;">
        <li><strong>Agente causal:</strong> Par√°sitos del g√©nero Plasmodium.</li>
        <li><strong>Transmisi√≥n:</strong> Picadura de mosquitos hembra del g√©nero Anopheles.</li>
        <li><strong>S√≠ntomas:</strong> Fiebre, escalofr√≠os y dolor de cabeza, que aparecen 10 a 15 d√≠as despu√©s de la picadura.</li>
        <li><strong>Complicaciones:</strong> Algunos tipos de malaria pueden ser mortales.</li>
      </ul>
    </div>

    <div style="margin-top:16px;">
      <h4 style="color:var(--accent); margin-bottom:8px; display:flex; align-items:center; gap:8px;">
        <span style="background:#3b82f6; color:#1e40af; padding:4px 8px; border-radius:6px; font-size:14px;">3</span>
        Leptospirosis
      </h4>
      <ul style="margin-left:20px; color:var(--muted); font-size:13px; line-height:1.6;">
        <li><strong>Agente causal:</strong> Bacteria del g√©nero Leptospira.</li>
        <li><strong>Transmisi√≥n:</strong> Contacto directo con orina de animales infectados o con tierra o agua contaminada con esta orina.</li>
        <li><strong>S√≠ntomas:</strong> Puede variar desde un cuadro leve hasta una enfermedad grave que afecta m√∫ltiples √≥rganos.</li>
        <li><strong>Complicaciones:</strong> Puede causar disfunci√≥n de √≥rganos como ri√±ones, h√≠gado, pulmones y cerebro. A menudo se asocia con brotes despu√©s de lluvias fuertes, ya que las bacterias sobreviven mejor en ambientes h√∫medos.</li>
      </ul>
    </div>

    <div style="margin-top:20px; padding:14px; background:rgba(37,99,235,0.05); border-radius:10px; border-left:4px solid var(--accent);">
      <h4 style="color:var(--accent); margin-bottom:8px;">Puntos clave para diagn√≥stico y tratamiento</h4>
      <p style="font-size:13px; color:var(--muted); line-height:1.6;">
        Dada la superposici√≥n de s√≠ntomas, especialmente en las primeras etapas, es fundamental un diagn√≥stico preciso basado en pruebas de laboratorio. El diagn√≥stico incorrecto puede llevar a retrasos en el tratamiento adecuado, lo que aumenta el riesgo de complicaciones graves e incluso de muerte. La coinfecci√≥n con estas enfermedades es posible y puede complicar el cuadro cl√≠nico y el manejo.
      </p>
    </div>
  </div>
</div>



    <!-- RIGHT: panel resultados -->
    <div class="resultados">
      <div class="panel resultado-box" id="resultadoBox">
        <h3 style="margin-bottom:10px;color:var(--accent);">Resultados del An√°lisis</h3>
        <div id="outputInitial">
          <p style="color:var(--muted)">No hay resultados a√∫n. Completa los s√≠ntomas y presiona <b>Predecir (local)</b> o carga un dataset.</p>
        </div>
        <!-- Resultado dinÔøΩÔøΩmico se inyecta aqu√≠ -->
      </div>

      <div class="panel" style="display:flex; flex-direction:column; gap:8px;">
        <strong style="color:var(--muted); font-size:13px;">Evaluar modelo</strong>
        <div style="display:flex; gap:8px; align-items:center;">
          <button id="btnProcessLocal" class="btn btn-yellow">Evaluar rendimiento</button>
        </div>
        <p style="font-size:12px; color:var(--muted); margin-top:8px;">
          Eval√∫a el modelo entrenado mostrando la precisi√≥n y matrices de confusi√≥n con datos reales vs predicciones.
        </p>
      </div>
    </div>

  </div>

  <!-- Modal para ampliar gr√°ficas -->
  <div id="modalGrafica" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <img id="modalImg" class="modal-img" src="" alt="Gr√°fica ampliada">
    </div>
  </div>

  <script>
    // Elementos
    const btnPredecir = document.getElementById('predecir');
    const btnCargarArchivo = document.getElementById('btnCargarArchivo');
    const fileInput = document.getElementById('fileInput');
    const fileInfo = document.getElementById('fileInfo');
    const fileName = document.getElementById('fileName');
    const modal = document.getElementById('modalGrafica');
    const modalImg = document.getElementById('modalImg');
    const closeModal = document.querySelector('.close');
    const btnPredecirSrv = document.getElementById('predecirServidor');
    const resultadoBox = document.getElementById('resultadoBox');
    const outputInitial = document.getElementById('outputInitial');
    const btnProcessLocal = document.getElementById('btnProcessLocal');
    const clearBtn = document.getElementById('clear');

    function getSymptoms() {
      return {
        fever: Number(document.getElementById('fiebre').value || 0),
        rash: Number(document.getElementById('rash').value || 0),
        abdominal_pain: Number(document.getElementById('abdominal_pain').value || 0),
        dizziness: Number(document.getElementById('dizziness').value || 0),
        chills: Number(document.getElementById('chills').value || 0),
        // nuevos opcionales
        hemoglobin: Number(document.getElementById('hemoglobin')?.value || 0),
        red_blood_cells: Number(document.getElementById('red_blood_cells')?.value || 0),
        white_blood_cells: Number(document.getElementById('white_blood_cells')?.value || 0),
      };
    }

    // L√≥gica de predicci√≥n local (puntuaci√≥n + normalizaci√≥n)
    function predictLocal(sym) {
      // Pesos heur√≠sticos (ajustables)
      const w = {
        dengue:  { fever: 0.4, rash: 0.45, abdominal_pain: 0.35, dizziness: 0.0,  chills: -0.05 },
        malaria: { fever: 0.5, rash: -0.2, abdominal_pain: 0.2, dizziness: 0.05, chills: 0.15 },
        lepto:   { fever: 0.35, rash: -0.15, abdominal_pain: 0.05, dizziness: 0.35, chills: 0.6 }
      };

      // Calcular score bruto
      let scoreD = Math.max(0, sym.fever*w.dengue.fever + sym.rash*w.dengue.rash + sym.abdominal_pain*w.dengue.abdominal_pain + sym.dizziness*w.dengue.dizziness + sym.chills*w.dengue.chills);
      let scoreM = Math.max(0, sym.fever*w.malaria.fever + sym.rash*w.malaria.rash + sym.abdominal_pain*w.malaria.abdominal_pain + sym.dizziness*w.malaria.dizziness + sym.chills*w.malaria.chills);
      let scoreL = Math.max(0, sym.fever*w.lepto.fever + sym.rash*w.lepto.rash + sym.abdominal_pain*w.lepto.abdominal_pain + sym.dizziness*w.lepto.dizziness + sym.chills*w.lepto.chills);

      const total = scoreD + scoreM + scoreL;

      if (total === 0) {
        return { label: null, confidences: { dengue:0, malaria:0, leptospirosis:0 } };
      }

      // Normalizar a porcentajes
      const pD = Math.round((scoreD / total) * 100);
      const pM = Math.round((scoreM / total) * 100);
      const pL = Math.round((scoreL / total) * 100);

      // Elegir la mayor probabilidad; desempate por score bruto
      const arr = [
        { name: 'Dengue', key: 'dengue', p: pD, raw: scoreD },
        { name: 'Malaria', key: 'malaria', p: pM, raw: scoreM },
        { name: 'Leptospirosis', key: 'leptospirosis', p: pL, raw: scoreL },
      ];
      arr.sort((a,b) => b.raw - a.raw);

      return {
        label: arr[0].name,
        key: arr[0].key,
        confidences: { dengue: pD, malaria: pM, leptospirosis: pL },
        raw: { dengue: scoreD, malaria: scoreM, leptospirosis: scoreL }
      };
    }

    // Render de resultado bonito
    function renderResult(pred, sym) {
      const container = document.createElement('div');
      container.innerHTML = ''; // limpiar
      if (outputInitial) outputInitial.style.display = 'none';

      if (!pred.label) {
        const title = document.createElement('div');
        title.innerHTML = '<p style="color:var(--muted)"><b>No se puede determinar</b>: los s√≠ntomas no aportan informaci√≥n suficiente.</p>';
        container.appendChild(title);
      } else {
        const resultTag = document.createElement('div');
        resultTag.className = 'enfermedad ' + (pred.key === 'dengue' ? 'dengue' : pred.key === 'malaria' ? 'malaria' : 'leptospirosis');
        resultTag.textContent = 'Posible contagio de ' + pred.label;
        container.appendChild(resultTag);

        }

      // Mostrar solo la etiqueta de resultado sin porcentajes
      const symBox = document.createElement('div');
      symBox.style.marginTop = '12px';
      symBox.innerHTML = `
        <hr style="border:none;height:1px;background:rgba(15,23,42,0.04);margin:12px 0;">
        <p style="font-weight:700;margin-bottom:6px;">S√≠ntomas ingresados</p>
        <ul style="list-style:none;padding-left:0;color:var(--muted)">
          <li>Fiebre: <b>${sym.fever ? 'S√≠' : 'No'}</b></li>
          <li>Rash: <b>${sym.rash ? 'S√≠' : 'No'}</b></li>
          <li>Dolor abdominal: <b>${sym.abdominal_pain ? 'S√≠' : 'No'}</b></li>
          <li>Mareos: <b>${sym.dizziness ? 'S√≠' : 'No'}</b></li>
          <li>Escalofr√≠os: <b>${sym.chills ? 'S√≠' : 'No'}</b></li>
        </ul>`;
      container.appendChild(symBox);

      // Replace contenido del resultadoBox
      resultadoBox.innerHTML = '<h3 style="margin-bottom:10px;color:var(--accent);">Resultados del An√°lisis</h3>';
      resultadoBox.appendChild(container);
    }

    // EVENTOS
    btnPredecir.addEventListener('click', () => {
      const sym = getSymptoms();
      const pred = predictLocal(sym);
      renderResult(pred, sym);
    });

    // Limpiar formulario
    clearBtn.addEventListener('click', () => {
      ['fiebre','rash','abdominal_pain','dizziness','chills','hemoglobin','red_blood_cells','white_blood_cells'].forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        if (el.tagName === 'SELECT') el.value = '0'; else el.value = '';
      });
      resultadoBox.innerHTML = '<h3 style="margin-bottom:10px;color:var(--accent);">Resultados del An√°lisis</h3><div id="outputInitial"><p style="color:var(--muted)">No hay resultados a√∫n. Completa los s√≠ntomas y presiona <b>Predecir (local)</b>.</p></div>';
      if (outputInitial) outputInitial.style.display = 'block';
    });

    // Env√≠o al servidor (si quieres mantener el backend)
    btnPredecirSrv.addEventListener('click', async () => {
      const formData = new FormData();
      const sym = getSymptoms();
      // agregamos los campos base
      formData.append('fever', sym.fever);
      formData.append('rash', sym.rash);
      formData.append('abdominal_pain', sym.abdominal_pain);
      formData.append('dizziness', sym.dizziness);
      formData.append('chills', sym.chills);
      // opcionales solo si hay valor
      const hem = document.getElementById('hemoglobin')?.value;
      if (hem !== undefined && hem !== '') formData.append('hemoglobin', hem);
      const rbc = document.getElementById('red_blood_cells')?.value;
      if (rbc !== undefined && rbc !== '') formData.append('red_blood_cells', rbc);
      const wbc = document.getElementById('white_blood_cells')?.value;
      if (wbc !== undefined && wbc !== '') formData.append('white_blood_cells', wbc);

      resultadoBox.innerHTML = '<p>üß† Enviando al servidor...</p>';
      try {
        const res = await fetch('/predecir', { method:'POST', body: formData });
        const data = await res.json();
        if (data.resultado || data.prediccion) {
          const label = data.resultado || data.prediccion;
          resultadoBox.innerHTML = `<h3 style="margin-bottom:10px;color:var(--accent);">Resultados del An√°lisis</h3><div class="enfermedad ${label.toLowerCase()}">${label}</div>`;
        } else {
          resultadoBox.innerHTML = `<p style="color:${data.error ? 'var(--danger)' : 'var(--muted)'}">${data.error || 'Error desconocido'}</p>`;
        }
      } catch (err) {
        resultadoBox.innerHTML = `<p style="color:var(--danger)"><b>Error:</b> No se pudo contactar el servidor.</p>`;
      }
    });

    // EVALUACI√ìN DEL MODELO
    btnProcessLocal.addEventListener('click', async () => {
      // Mostrar carga
      resultadoBox.innerHTML = '<h3 style="margin-bottom:10px;color:var(--accent);">Resultados del An√°lisis por Lotes</h3><p>Cargando evaluaci√≥n del modelo...</p>';
      
      try {
        // Llamar al endpoint de evaluaci√≥n del servidor
        const response = await fetch('/evaluar');
        const data = await response.json();
        
        if (data.error) {
          resultadoBox.innerHTML = `<p style="color:var(--danger)">Error: ${data.error}</p>`;
          return;
        }
        
        // Crear contenedor para resultados
        const container = document.createElement('div');
        
        // Mostrar precisi√≥n
        const precisionHTML = `
          <div style="margin-bottom:20px; padding:16px; background:linear-gradient(135deg, var(--accent), var(--accent-2)); 
                      border-radius:12px; color:white; text-align:center;">
            <div style="font-size:24px; font-weight:800; margin-bottom:8px;">
              Precisi√≥n del Modelo
            </div>
            <div style="font-size:48px; font-weight:900;">
              ${(data.precision * 100).toFixed(2)}%
            </div>
          </div>
        `;
        
        // Crear layout de 2 columnas para los gr√°ficos
        const graficasHTML = `
          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:16px; margin-top:20px;">
            <div style="background:white; padding:12px; border-radius:10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
              <h4 style="margin-bottom:10px; color:var(--accent);">Matriz de Confusi√≥n (Real vs Predicci√≥n)</h4>
              <img src="data:image/png;base64,${data.grafica_confusion}" 
                   style="width:100%; height:auto; border-radius:8px;" alt="Matriz de Confusi√≥n"
                   class="grafica-clickable" onclick="abrirModal(this.src)">
            </div>
            <div style="background:white; padding:12px; border-radius:10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
              <h4 style="margin-bottom:10px; color:var(--accent);">Distribuci√≥n y Predicciones</h4>
              <img src="data:image/png;base64,${data.grafica_dispersion}" 
                   style="width:100%; height:auto; border-radius:8px;" alt="Gr√°fica de Dispersi√≥n"
                   class="grafica-clickable" onclick="abrirModal(this.src)">
            </div>
          </div>
        `;
        
        container.innerHTML = precisionHTML + graficasHTML;
        
        // Limpiar y mostrar resultados
        resultadoBox.innerHTML = '<h3 style="margin-bottom:10px;color:var(--accent);">Resultados de Evaluaci√≥n del Modelo</h3>';
        resultadoBox.appendChild(container);
        
      } catch (error) {
        resultadoBox.innerHTML = `<p style="color:var(--danger)">Error al evaluar el modelo: ${error.message}</p>`;
      }
    });

    // ==========================================
    // FUNCIONALIDAD DE CARGA DE ARCHIVOS EXCEL
    // ==========================================
    btnCargarArchivo.addEventListener('click', () => {
      fileInput.click();
    });

    fileInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      // Mostrar informaci√≥n del archivo
      fileName.textContent = file.name;
      fileInfo.style.display = 'block';
      btnCargarArchivo.textContent = 'Procesando...';
      btnCargarArchivo.disabled = true;

      // Crear FormData para enviar el archivo
      const formData = new FormData();
      formData.append('file', file);

      // Mostrar carga en resultados
      resultadoBox.innerHTML = '<h3 style="margin-bottom:10px;color:var(--accent);">Resultados del An√°lisis por Lotes</h3><p>Cargando y procesando archivo...</p>';

      try {
        const response = await fetch('/predecir_lote', {
          method: 'POST',
          body: formData
        });

        const data = await response.json();

        if (data.error) {
          resultadoBox.innerHTML = `<p style="color:var(--danger)">Error: ${data.error}</p>`;
          btnCargarArchivo.textContent = 'Seleccionar archivo Excel';
          btnCargarArchivo.disabled = false;
          return;
        }

        // Crear contenedor para resultados
        const container = document.createElement('div');

        // Mostrar estad√≠sticas
        let estadisticasHTML = `
          <div style="margin-bottom:20px; padding:16px; background:linear-gradient(135deg, var(--accent), var(--accent-2)); 
                      border-radius:12px; color:white; text-align:center;">
            <div style="font-size:20px; font-weight:800; margin-bottom:8px;">
              Total de Casos Procesados
            </div>
            <div style="font-size:36px; font-weight:900;">
              ${data.estadisticas.total_casos}
            </div>
          </div>
        `;

        if (data.estadisticas.precision) {
          estadisticasHTML += `
            <div style="margin-bottom:20px; padding:16px; background:linear-gradient(135deg, #10b981, #059669); 
                        border-radius:12px; color:white; text-align:center;">
              <div style="font-size:20px; font-weight:800; margin-bottom:8px;">
                Precisi√≥n del Modelo
              </div>
              <div style="font-size:36px; font-weight:900;">
                ${(data.estadisticas.precision * 100).toFixed(2)}%
              </div>
            </div>
          `;
        }

        // Distribuci√≥n de enfermedades
        let distribucionHTML = '<div style="background:white; padding:16px; border-radius:10px; margin-bottom:20px;"><h4 style="margin-bottom:12px; color:var(--accent);">Distribuci√≥n de Predicciones</h4>';
        for (const [enfermedad, cantidad] of Object.entries(data.estadisticas.distribucion)) {
          const porcentaje = (cantidad / data.estadisticas.total_casos * 100).toFixed(1);
          distribucionHTML += `
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
              <span>${enfermedad}:</span>
              <span style="font-weight:700;">${cantidad} (${porcentaje}%)</span>
            </div>
          `;
        }
        distribucionHTML += '</div>';
        
        // Gr√°ficas
        let graficasHTML = '<div style="display:grid; grid-template-columns: 1fr 1fr; gap:16px; margin-top:20px;">';
        
        if (data.grafica_confusion) {
          graficasHTML += `
            <div style="background:white; padding:12px; border-radius:10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
              <h4 style="margin-bottom:10px; color:var(--accent);">Matriz de Confusi√≥n</h4>
              <img src="data:image/png;base64,${data.grafica_confusion}" 
                   style="width:100%; height:auto; border-radius:8px;" alt="Matriz de Confusi√≥n"
                   class="grafica-clickable" onclick="abrirModal(this.src)">
            </div>
          `;
        }
        
        graficasHTML += `
          <div style="background:white; padding:12px; border-radius:10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <h4 style="margin-bottom:10px; color:var(--accent);">Distribuci√≥n de Predicciones</h4>
            <img src="data:image/png;base64,${data.grafica_dispersion}" 
                 style="width:100%; height:auto; border-radius:8px;" alt="Gr√°fica de Dispersi√≥n"
                 class="grafica-clickable" onclick="abrirModal(this.src)">
          </div>
        `;
        
        graficasHTML += '</div>';
        
        container.innerHTML = estadisticasHTML + distribucionHTML + graficasHTML;

        // Limpiar y mostrar resultados
        resultadoBox.innerHTML = '<h3 style="margin-bottom:10px;color:var(--accent);">Resultados del An√°lisis por Lotes</h3>';
        resultadoBox.appendChild(container);

      } catch (error) {
        resultadoBox.innerHTML = `<p style="color:var(--danger)">Error al procesar archivo: ${error.message}</p>`;
      }

      // Restaurar bot√≥n
      btnCargarArchivo.textContent = 'Seleccionar archivo Excel';
      btnCargarArchivo.disabled = false;
      fileInput.value = '';
    });

    // ==========================================
    // FUNCIONALIDAD DEL MODAL PARA AMPLIAR GR√ÅFICAS
    // ==========================================
    function abrirModal(src) {
      modalImg.src = src;
      modal.style.display = 'block';
    }

    closeModal.addEventListener('click', () => {
      modal.style.display = 'none';
    });

    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.style.display = 'none';
      }
    });

    // Cerrar modal con tecla ESC
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        modal.style.display = 'none';
      }
    });

    // Peque√±a animaci√≥n inicial en las barras si hay
    document.addEventListener('DOMContentLoaded', () => {
      // placeholder
    });

  </script>
</body>
</html>
